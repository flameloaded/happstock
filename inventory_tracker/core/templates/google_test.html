<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign in with Google</title>
  <style>
  body {
    background: linear-gradient(to bottom, #111827, #1f2937);
    font-family: sans-serif;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  .card {
    background-color: #1f2937;
    padding: 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  .google-button {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
  }
  .loading, .error, .success {
    margin-top: 1rem;
    font-size: 0.9rem;
  }
  .error {
    color: red;
  }
  .success {
    color: green;
  }
  .token-display {
    background-color: #374151;
    padding: 1rem;
    border-radius: 0.25rem;
    margin-top: 1rem;
    word-break: break-all;
    font-family: monospace;
    font-size: 0.75rem;
    text-align: left;
  }
</style>
</head>
<body>
  <div class="card">
    <h2>Welcome</h2>
    <p>Sign in to your account</p>
    <div id="googleSignInDiv" class="google-button"></div>
    <div id="loading" class="loading" style="display: none;">Signing inâ€¦</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="success" class="success" style="display: none;"></div>
    <div id="tokenDisplay" class="token-display" style="display: none;"></div>
    <p style="font-size: 0.75rem; margin-top: 2rem;">
        By signing in, you agree to our
        <a href="#" style="color: #3b82f6;">Terms of Service</a> and
        <a href="#" style="color: #3b82f6;">Privacy Policy</a>.
    </p>
</div>

<script>
  const api = "https://happstock.onrender.com"; // Update with your server URL
  const loadingEl = document.getElementById("loading");
  const errorEl = document.getElementById("error");
  const successEl = document.getElementById("success");
  const tokenDisplayEl = document.getElementById("tokenDisplay");

  function handleCallbackResponse(response) {
    console.log("Response received:", response);
    
    // Show loading state
    loadingEl.style.display = "block";
    errorEl.style.display = "none";
    successEl.style.display = "none";
    tokenDisplayEl.style.display = "none";
    
    // Prepare form data
    const formData = new FormData();
    formData.append("token", response.credential);
    
    // Send token to your Django API
    fetch(`${api}/google_login/`, {
        method: "POST",
        body: formData,
    })
    .then(res => {
        console.log("Response status:", res.status, res.statusText);
        if (!res.ok) {
            throw new Error("Login failed. Please try again.");
        }
        return res.json();
    })
    .then(data => {
        console.log("Login successful:", data);
        
        // Display success message
        successEl.textContent = "Login successful! Tokens received:";
        successEl.style.display = "block";
        
        // Display tokens in the div
        const tokenInfo = {
        tokens: data.tokens,
        full_response: data
        };
        
        tokenDisplayEl.innerHTML = `
        <strong>Access Token:</strong><br>
        ${tokenInfo.tokens || 'Not found'}<br><br>
        <strong>Full Response:</strong><br>
        ${JSON.stringify(data, null, 2)}
        `;
        tokenDisplayEl.style.display = "block";
    })
    .catch(err => {
        console.error("Login error:", err);
        errorEl.textContent = "An unexpected error occurred. Please try again.";
        errorEl.style.display = "block";
    })
    .finally(() => {
        console.log("Finally block executed");
        loadingEl.style.display = "none";
    });
    }


    window.onload = () => {
    if (window.google && window.google.accounts) {
        window.google.accounts.id.initialize({
        client_id: "958992113944-fonnluld5mf8fcm73736b2afhaaobiqg.apps.googleusercontent.com", // Replace with your actual client ID
        callback: handleCallbackResponse
        });
        
        window.google.accounts.id.renderButton(
        document.getElementById("googleSignInDiv"),
        { 
            theme: "outline", 
            size: "large",
            text: "sign_in_with",
            shape: "rectangular"
        }
        );
    } else {
        document.getElementById("googleSignInDiv").innerHTML = 
        "Google script not loaded. Please refresh the page.";
    }
    };
</script>

</body>
</html>